<%-include('../layout/adminHeader')-%>
    <div class="container-scroller">
      <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <div class="sidebar-brand-wrapper d-none d-lg-flex align-items-center justify-content-center fixed-top">
          <a class="sidebar-brand brand-logo" href="../../index.html"><img src="../../assets2/images/logo.svg" alt="logo" /></a>
          <a class="sidebar-brand brand-logo-mini" href="../../index.html"><img src="../../assets2/images/logo-mini.svg" alt="logo" /></a>
        </div>
        <ul class="nav">
          <li class="nav-item profile">
            <div class="profile-desc">
              <div class="profile-pic">
                <div class="count-indicator">
                  <img class="img-xs rounded-circle " src="../../assets2/images/faces/face15.jpg" alt="">
                  <span class="count bg-success"></span>
                </div>
                <div class="profile-name">
                  <h5 class="mb-0 font-weight-normal">Henry Klein</h5>
                  <span>Gold Member</span>
                </div>
              </div>
              <a href="#" id="profile-dropdown" data-toggle="dropdown"><i class="mdi mdi-dots-vertical"></i></a>
              <div class="dropdown-menu dropdown-menu-right sidebar-dropdown preview-list" aria-labelledby="profile-dropdown">
                <a href="#" class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-settings text-primary"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject ellipsis mb-1 text-small">Account settings</p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-onepassword  text-info"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject ellipsis mb-1 text-small">Change Password</p>
                  </div>
                </a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item preview-item">
                  <div class="preview-thumbnail">
                    <div class="preview-icon bg-dark rounded-circle">
                      <i class="mdi mdi-calendar-today text-success"></i>
                    </div>
                  </div>
                  <div class="preview-item-content">
                    <p class="preview-subject ellipsis mb-1 text-small">To-do list</p>
                  </div>
                </a>
              </div>
            </div>
          </li>
          <li class="nav-item nav-category">
            <span class="nav-link">Navigation</span>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link" href="/admin/dashboard">
              <span class="menu-icon">
                <i class="mdi mdi-speedometer"></i>
              </span>
              <span class="menu-title">Dashboard</span>
            </a>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link" href="/admin/user">
              <span class="menu-icon">
                <i class="mdi mdi-speedometer"></i>
              </span>
              <span class="menu-title">All User</span>
            </a>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link" href="/admin/all-products">
              <span class="menu-icon">
                <i class="mdi mdi-playlist-play"></i>
              </span>
              <span class="menu-title">All Products</span>
            </a>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link" href="/admin/addproduct">
              <span class="menu-icon">
                <i class="mdi mdi-table-large"></i>
              </span>
              <span class="menu-title">Add a new Products</span>
            </a>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link" href="/admin/category">
              <span class="menu-icon">
                <i class="mdi mdi-chart-bar"></i>
              </span>
              <span class="menu-title">Category</span>
            </a>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link" href="/admin/editcategory">
              <span class="menu-icon">
                <i class="mdi mdi-contacts"></i>
              </span>
              <span class="menu-title">Edit Category</span>
            </a>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link"  href="/admin/orders" >
              <span class="menu-icon">
                <i class="mdi mdi-security"></i>
              </span>
              <span class="menu-title">Orders</span>              
            </a>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link"  href="/admin/coupens" >
              <span class="menu-icon">
                <i class="mdi mdi-security"></i>
              </span>
              <span class="menu-title">Coupens</span>              
            </a>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link"  href="/admin/offer" >
              <span class="menu-icon">
                <i class="mdi mdi-security"></i>
              </span>
              <span class="menu-title">Offer</span>              
            </a>
          </li>
          <li class="nav-item menu-items">
            <a class="nav-link" href="/admin/sales">
              <span class="menu-icon">
                <i class="mdi mdi-file-document-box"></i>
              </span>
              <span class="menu-title">Sales Report</span>
            </a>
          </li>
        </ul>
      </nav>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <!-- partial:../../partials/_navbar.html -->
        <nav class="navbar p-0 fixed-top d-flex flex-row">
          <div class="navbar-brand-wrapper d-flex d-lg-none align-items-center justify-content-center">
            <a class="navbar-brand brand-logo-mini" href="../../index.html"><img src="../../assets/images/logo-mini.svg" alt="logo" /></a>
          </div>
          <div class="navbar-menu-wrapper flex-grow d-flex align-items-stretch">
            <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
              <span class="mdi mdi-menu"></span>
            </button>
            <ul class="navbar-nav w-100">
              <li class="nav-item w-100">
                <form class="nav-link mt-2 mt-md-0 d-none d-lg-flex search">
                  <input type="text" class="form-control" placeholder="Search user">
                </form>
              </li>
            </ul>
            <ul class="navbar-nav navbar-nav-right">  
              <li>
                <a type="button" href="/admin/logout">Logout</a>
               </li>            
      
            </ul>
            <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
              <span class="mdi mdi-format-line-spacing"></span>
            </button>
          </div>
        </nav>
        <!-- partial -->
        <div class="main-panel">
          <div class="content-wrapper">
            <h3>Orders</h3>
            <table class="table table-striped">
                <thead>
                  <tr>
                    <th scope="col">OrderID</th>
                    <th scope="col">UserName</th>
                    <th scope="col">Product Name</th>
                    <th scope="col">Qty</th>
                    <th scope="col">Payment Method</th>
                    <th scope="col">Order Status</th>
                    <th scope="col">Action</th>
                    <th scope="col">Return Requests</th>
                  </tr>
                </thead>
                <tbody>
                  <% orders.forEach((order) => { %>
                    <% order.products.forEach((product) => { %>
                  <tr >
                    <td><%=order?.order_id %></td>
                    <td><%=order?.userId?.name %></td>
                    <td><%=product?.name %></td>
                    <td><%=product?.quantity %></td>
                    <td><%=order?.paymentMethod %></td>
                    <td id='product<%=product?._id%>order<%=order?._id %>' style="width:200px" ><%=product?.orderStatus %></td>
                    <td> 
                      <% if(product?.orderStatus =="Placed") { %>
                      <button id='button<%=product?._id%>' class="btn " value="Packed" onclick="action(this.value,'<%=order._id %>','<%=product?._id%>')"  style="width:200px;background-color:#004080; color: white;" >Proceed To Pack </button>
                      <% }else if(product?.orderStatus =="Packed") { %>
                      <button id='button<%=product?._id%>' class="btn " value="Shipped" onclick="action(this.value,'<%=order._id %>','<%=product?._id%>')"  style="width:200px;background-color: #ff6600; color: white;" >Proceed To Ship </button>
                      <% }else if(product?.orderStatus =="Shipped") { %>
                      <button id='button<%=product?._id%>' class="btn " value="Delivered" onclick="action(this.value,'<%=order._id %>','<%=product?._id%>')"  style="width:200px;background-color: #66ccff; color: white;" >Proceed To Delivery </button>
                      <% }else if(product?.orderStatus =="Delivered") { %>
                        <button id='button<%=product?._id%>' class="btn " style="width:200px;background-color: #00cc66; color: white;">Product Delivered </button>
                      <% }else if(product?.orderStatus =="Canceled") { %>
                        <button id='button<%=product?._id%>' class="btn " disabled value="Canceled"   style="width:200px;background-color: #b9b9b9; color: white;" >Disabled </button>
                        <% }else if(product?.orderStatus =="Product Returned") { %>
                          <button id='button<%=product?._id%>' class="btn " disabled value="Canceled"   style="width:200px;background-color: #b9b9b9; color: white;" >Disabled </button>
                        <% }else if(product?.orderStatus =="Requested Return") { %>
                          <button id='button<%=product?._id%>' class="btn " disabled    style="width:200px;background-color: #b9b9b9; color: white;" >Disabled </button>
                      <% }else if(product?.orderStatus =="Reject Request") { %>
                      <button id='button<%=product?._id%>' class="btn " disabled   style="width:200px;background-color:  #b9b9b9; color: white;" >Disabled </button>
                      <% } %> 
                    </td>
                    
                    <td>
                    <% if(product?.orderStatus =="Requested Return"){ %>
                     <div style="margin-right: 10px;">
                    <select class="form-select" name="maincategory" style="width: 250px;" aria-label="Default select example"  onchange=" request(this.value,'<%=order._id %>','<%=product?._id%>')">
                      <option value="" disabled selected>Select An Option</option>
                      <option value="Reject Request">Reject Request</option>
                      <option value="Approve Request">Approve Request</option>
                    </select>
                </div>
                  
                <% } else { %>
                  <p style="width: 250px;">No Requests</p>
                  <% } %>
                </td>
                  </tr>
                  <% }) %>
              <% }) %>
              
                </tbody>
              </table>
              <div class="pagination">
                <% if (currentPage > 1) { %>
                    <a href="?page=<%= currentPage - 1 %>" class="page-link">Previous</a>
                <% } %>
                
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <a href="?page=<%= i %>" class="page-link <%= i === currentPage ? 'active' : '' %>"><%= i %></a>
                <% } %>
                
                <% if (currentPage < totalPages) { %>
                    <a href="?page=<%= currentPage + 1 %>" class="page-link">Next</a>
                <% } %>
              </div>
          </div>
          <!-- Add pagination controls after the table -->


          <!-- content-wrapper ends -->
          <!-- partial:../../partials/_footer.html -->
          
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->
    <!-- plugins:js -->


    


<script>
  
   function showAlert(){
    alert("this wiill delete the category")
   }

   function action(status,orderId,productId){
    const data = {
      currentStatus:status,
      orderId:orderId,
      productId:productId
    }

    axios.post("/admin/order-status",data)
    .then(response =>{
      console.log(response.data);
      document.getElementById(`product${productId}order${orderId}`).innerText = response.data.currentStatus;
      const button = document.getElementById(`button${productId}`);
      if (button) {
        switch (status) {
          
          case 'Packed':
            button.innerText = 'Proceed To Ship';
            button.value = 'Shipped';
            button.onclick = () => action('Shipped', orderId, productId);

             button.style.backgroundColor = '#ff6600'
            break;
          case 'Shipped':
            button.innerText = 'Proceed To Delivery';
            button.value = 'Delivered';
            button.onclick = () => action('Delivered', orderId, productId);
             button.style.backgroundColor = '#66ccff'
            break;
          case 'Delivered':
            button.innerText = 'Product Delivered';
            button.value = '';  // Optionally, clear the value if needed
            button.onclick = null;  // Optionally, remove the click event if needed
            button.style.backgroundColor = '#36ee4c'
            break;
          
          default:
            break;
        }
      }
    })
    .catch(error=>{
      console.error(error);
    })
   }

//-----------------------  return Request ------------------------

function request(status,orderId,productId){
  const data = {
    status:status,
    orderId:orderId,
    productId:productId
  }
  axios.post("/admin/customer-Request",data)
  .then(response =>{
      console.log(response.data);
      const orderStatus = response.data.status
      document.getElementById(`product${productId}order${orderId}`).innerText = orderStatus
  })
  .catch(error=>{
      console.error(error);
    })
}
   

</script>
    


<%-include('../layout/adminHeader')-%>

  
  </body>
</html>